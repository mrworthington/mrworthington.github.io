---
title: "Testing Out Different Libraries"
description: |
  In this post, we test out a few features to make sure this blog can be interactive. First is ggplot2, second is ggiraph, and last is highcharter.
author:
  - name: Matt Worthington 
    url: https://mrworthington.com/about
    affiliation: Me, Myself, and I
    affiliation_url: https://mrworthington.com
date: 05-20-2020
draft: true
creative_commons: CC BY-NC
output:
  distill::distill_article:
    css: hospital_header.css
    self_contained: false
preview: dan-gold-pexByC8iQE4-unsplash-3.jpg
twitter:
  creator: "@mrworthington"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Learn more about creating blogs with Distill at:
# https://rstudio.github.io/distill/blog.html

```

This evening, [the Ed Trust is hosting a discussion on twitter at 8PM ET](https://edtrust.org/resource/funding-gaps-2018/) on school funding inequity, so I thought I would do a code-through of a visualization I made this past summer while researching the legacy of a famous school finance Supreme Court case that ended up determining that [Americans had no fundamental right to an education](https://www.folomedia.org/americans-no-right-education/). In short, it shows the shares of funding over time for each of the three main sources of funding for public education in America: federal funding, state funding, and local funding (mostly property taxes).

## GGiraph Test

```{r echo=FALSE, message=FALSE, warning=FALSE, layout="l-page", fig.height=6}
library(ggiraph)
library(tidyverse)
library(gfonts)
library(flextable)
library(tinter)
ts_county_cases <- read_csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv")
sf_counties <- tidycensus::county_laea
ts_county_cases_sf <- ts_county_cases %>% 
  filter(date=="2020-03-27",
         state=="Texas") %>% 
  left_join(sf_counties, by=c("fips"="GEOID")) %>% 
  sf::st_as_sf()
# flextable part -----
fun_flextable <- function(dat){
  ft <- flextable(dat, col_keys = c("county", "cases", "deaths"), 
                  defaults = list(fontname = "Whitney SSm A"), 
                  theme_fun = theme_vanilla)
  ft <- fontsize(ft, part = "all", size = 20)
  ft <- bold(ft, part = "header", bold = TRUE)
  ft <- color(ft, color = "black", part = "all")
  ft <- set_table_properties(ft, layout = "autofit")
  as.character(htmltools_value(ft))
}
temp_dat <- as.data.frame(ts_county_cases_sf)[,c("county", "cases", "deaths")]
temp_dat <- split(temp_dat, seq_len(nrow(temp_dat)))
ts_county_cases_sf$tooltip <- map_chr(temp_dat, fun_flextable)
# end of flextable part
tx_map <- ts_county_cases_sf %>%
  ggplot() +
  geom_sf(data=sf_counties %>% filter(str_detect(GEOID,"48")),color="#dddddd", fill="#f2f2f2", lwd=.3) +
  geom_sf_interactive(aes(fill=cases, tooltip=tooltip, data_id = county), lwd=.3) +
  scale_fill_gradientn(colours = tinter("#5da5da", steps = 5), labels = function(x) paste0(x,"Cases")) +
  coord_sf(datum=NA) +
  hrbrthemes::theme_ipsum_es(base_family="Whitney SSm A") +
  theme(plot.title = element_text(family="Whitney SSm A", face = "bold"),
        plot.subtitle = element_text(family="Whitney SSm A", face = "plain"),
        plot.caption = element_text(family="Whitney SSm A", face = "plain")) + 
  labs(title="Confirmed COVID-19 Cases By County - Texas",
       subtitle="As of March 26th, 2020",
       caption="SOURCE: New York Times COVID-19 Database")
girafe(ggobj = tx_map, fonts = list(sans = "Whitney SSm A"), width_svg = 12, height_svg = 8,
       options = list(
         opts_tooltip(css = "padding:5px;background:white;border-radius:2px 2px 2px 2px;"),
         opts_hover_inv(css = "opacity:0.8;"),
         opts_hover(css = "stroke-width:2;")
       ))
```


```{r include=FALSE}

tx2036_hc <- hc_theme_merge(
  hc_theme_smpl(),
  hc_theme(chart = list(backgroundColor = "#fff", 
                        style = list(fontFamily = '"Ringside Narrow SSm A", "Ringside Narrow SSm B", -apple-system, sans-serif !important', 
                                     fontSize = "28px", 
                                     color="#4d4d4d",fontWeight="800", textTransform="uppercase")),
           title = list(style = list(fontFamily = '-apple-system, sans-serif !important', 
                                     fontWeight = "bold",
                                     color="#2d2d2d"),
                        align = "left"), 
           subtitle = list(style = list(fontFamily = '"Ringside Narrow SSm A", "Ringside Narrow SSm B", -apple-system, sans-serif !important',
                                        color="#7d7d7d",
                                        textTransform="initial",
                                        fontWeight="400",
                                        fontSize = "14px"),
                           align = "left"), 
           legend = list(align = "right", 
                         style = list(fontFamily = '"Ringside Narrow SSm A", "Ringside Narrow SSm B", -apple-system, sans-serif !important', color="#6d6d6d"),
                         itemStyle = list(fontFamily = '"Ringside Narrow SSm A", "Ringside Narrow SSm B", -apple-system, sans-serif !important', color = '#6d6d6d'),
                         itemHoverStyle = list(color = 'gray'),   
                         verticalAlign = "top"),
           credits = list(style = list(color = "#fff")),
           xAxis = list(labels =list(style = list(fontFamily = '"Ringside Narrow SSm A", "Ringside Narrow SSm B", -apple-system, sans-serif !important', color="#2d2d2d")), 
                        title = list(style = list(color = "#4d4d4d", fontSize = "12px", 
                                                  color="#4d4d4d",fontWeight="500")),
                        gridLineWidth = 0,
                        gridLineColor = "#9d9d9d", 
                        lineColor = 'rgba(0,0,0,0.7)', 
                        minorGridLineColor = 'rgba(0,0,0,0.7)', 
                        tickColor = "#9d9d9d", 
                        tickWidth = 1), 
           yAxis = list(labels =list(style = list(fontFamily = '"Ringside Narrow SSm A", "Ringside Narrow SSm B", -apple-system, sans-serif !important', color="#2d2d2d")), 
                        title = list(style = list(color = "#fff", fontSize = "12px", 
                                                  color="#fff",fontWeight="500")), 
                        gridLineWidth = .5,
                        gridLineColor = 'rgba(0,0,0,0.15)', 
                        lineColor = 'rgba(0,0,0,0.15)', 
                        minorGridLineColor = 'rgba(0,0,0,0.15)', 
                        tickColor = "#9d9d9d", 
                        tickWidth = 2)))

   myMenuItems <- c("downloadCSV", "downloadCSV", "separator", "downloadPNG", "downloadJPEG", "downloadPDF")


```

```{r echo=FALSE, message=FALSE, warning=FALSE, layout="l-body"}

library(tidyverse)
library(janitor)
library(gfonts)
library(flextable)
library(tinter)
library(geojsonsf)
library(highcharter)
library(tigris)
library(geojson)
library(sf)

tx_zips <- tigris::zctas(state="TX",cb=TRUE) 

sf_counties <- tigris::counties(state="TX") %>% filter(GEOID=="48453")

# geo_travis <- geojsonsf::sf_geojson(sf_counties)

# For ArcGIS Data, The service ID is the key that goes after the datasets directory. Then use the 'ID' provided to pull the data into whatever format you want. For ATX, visit this site: https://services.arcgis.com/0L95CJ0VTaxqcmED/ArcGIS/rest/services/web0723/FeatureServer

atx_covid_zips_cases <- readr::read_csv("https://opendata.arcgis.com/datasets/4d913cdf3d894c3898696a7216e44180_02.csv") %>% 
  janitor::clean_names() %>% 
  dplyr::mutate(zipcode=as.character(zipcode))

atx_zips_by_cases_sf <- atx_covid_zips_cases %>%
  dplyr::left_join(tx_zips, by=c("zipcode"="GEOID10")) %>% 
  dplyr::select(zipcode, count, geometry) %>% 
  sf::st_as_sf() %>% 
  st_transform(102739)

# Have tried adding `st_transform(102739)` here (right after st_as_sf()), but despite correctly rendering in ggplot2 or elsewhere, it seems the transformation doesn't stick when the shapefile is converted to geojson format.

geo_zips_travis <- sf_geojson(atx_zips_by_cases_sf)

crs <- '{
  "type": "name",
    "properties": {
      "name": "urn:ogc:def:crs:EPSG:102739"
  }
}'

geo_zips_travis <- geo_zips_travis %>% geojson::crs_add(crs)

 # In the highcharts, library, there is a function called hc-transform that helps you add this inside of custom geojson objects. I just haven't been able to find a way to add the hc-transform into custom geojson objects. Here's a sample of hc-transform from one of the maps in highcharts own maps library:
 # "hc-transform": {
 #    "default": {
 #      "crs": "+proj=lcc +lat_1=32.13333333333333 +lat_2=33.96666666666667 +lat_0=31.66666666666667 +lon_0=-98.5 +x_0=600000 +y_0=2000000 +ellps=GRS80 +units=m +no_defs",
 #      "scale": 0.000561591402519,
 #      "jsonres": 15.5,
 #      "jsonmarginX": -999,
 #      "jsonmarginY": 9851,
 #      "xoffset": -169837.133029,
 #      "yoffset": 2545161.1438
 #    }
 #  },

geo_zips_travis <- jsonlite::fromJSON(geo_zips_travis, simplifyVector = FALSE)

# stops <- color_stops(n = 10, colors = c("#3A4A9F", "#FFFFFF", "#F26852"))

highchart() %>%
  hc_add_series_map(geo_zips_travis,atx_covid_zips_cases, value = "count", joinBy = "zipcode", name = "COVID-19 in Austin") %>% 
  hc_add_series(mapData = geo_travis, showInLegend = FALSE, nullColor = "transparent", borderColor = "#000",
                borderWidth = 3) %>%
  hc_title(
    text ="Texas Effective Reproduction Rate · R<sub>t</sub>",
    useHTML = TRUE) %>% 
  hc_subtitle(
    text ="From R<sub>t</sub> Live: R<sub>t</sub>  is the average number of people who become infected by an infectious person.",
    useHTML = TRUE) %>%
  hc_tooltip(table = FALSE, sort = FALSE,
             pointFormat = "Zip: {point.zipcode}<br>Confirmed Cases: {point.count:,.0f}") %>% 
  hc_credits(
    enabled = TRUE,
    text = "Source: rt.live Analysis",
    href = "https://rt.live") %>%
  hc_add_theme(tx2036_hc) %>%
  hc_colorAxis(minColor = "#f7fbff", maxColor = "#08306b") %>% 
  hc_size(height = 700) %>% 
        hc_exporting(enabled=TRUE, scale=2, sourceWidth= 1200, sourceHeight = 600, 
                     allowHTML = TRUE,
                     buttons = list(contextButton = list(menuItems = myMenuItems, 
                                                         title = "Export This Chart",
                                                         symbol = 'menuball', 
                                                         symbolStrokeWidth = 1,
                                                         symbolFill = 'rgba(93,165,218, 0.9)',
                                                         symbolStroke ='#4d4d4d',
                                                         theme = list(fill='#ffffff'))),
                     chartOptions = list(title =  list(style = list(fontWeight = '800', fontSize = '22px', textTransform = "uppercase")),
                                         subtitle =  list(style = list(fontSize = '14px'))))

```

## Testing Highcharts

```{r echo=FALSE, message=FALSE, warning=FALSE, layout="l-page", fig.height=5}
library(highcharter)
library(vroom)
library(lubridate)
library(janitor)
tx2036_hc <- hc_theme_merge(
  hc_theme_smpl(),
  hc_theme(chart = list(backgroundColor = "#fff", 
                        style = list(fontFamily = '-apple-system, sans-serif !important', 
                                     fontSize = "28px", 
                                     color="#4d4d4d",fontWeight="800", textTransform="uppercase")),
           title = list(style = list(fontFamily = '-apple-system, sans-serif !important', 
                                     fontWeight = "bold",
                                     color="#2d2d2d"),
                        align = "left"), 
           subtitle = list(style = list(fontFamily = '-apple-system, sans-serif !important',
                                        color="#7d7d7d",
                                        textTransform="initial",
                                        fontWeight="400",
                                        fontSize = "14px"),
                           align = "left"), 
           legend = list(align = "right", 
                         style = list(fontFamily = '-apple-system, sans-serif !important', color="#6d6d6d"),
                         itemStyle = list(fontFamily = '-apple-system, sans-serif !important', color = '#6d6d6d'),
                         itemHoverStyle = list(color = 'gray'),   
                         verticalAlign = "top"),
           credits = list(style = list(color = "#fff")),
           xAxis = list(labels =list(style = list(fontFamily = '-apple-system, sans-serif !important', color="#2d2d2d")), 
                        title = list(style = list(color = "#4d4d4d", fontSize = "12px", 
                                                  color="#4d4d4d",fontWeight="500")),
                        gridLineWidth = 0,
                        gridLineColor = "#9d9d9d", 
                        lineColor = 'rgba(0,0,0,0.7)', 
                        minorGridLineColor = 'rgba(0,0,0,0.7)', 
                        tickColor = "#9d9d9d", 
                        tickWidth = 1), 
           yAxis = list(labels =list(style = list(fontFamily = '-apple-system, sans-serif !important', color="#2d2d2d")), 
                        title = list(style = list(color = "#fff", fontSize = "12px", 
                                                  color="#fff",fontWeight="500")), 
                        gridLineWidth = .5,
                        gridLineColor = 'rgba(0,0,0,0.15)', 
                        lineColor = 'rgba(0,0,0,0.15)', 
                        minorGridLineColor = 'rgba(0,0,0,0.15)', 
                        tickColor = "#9d9d9d", 
                        tickWidth = 2)))

key_events <- vroom("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2q_c5RpywszCamM3VINgAwZ51OJoPfBFflEvXpuAqAZrw9SDovcGnfDOlF7uwzCnZf5XMkEluhlUb/pub?output=csv") %>% 
  clean_names() %>% 
  mutate(date=as_date(date))

r_naught <- vroom("https://d14wlfuexuxgcm.cloudfront.net/covid/rt.csv") %>% 
  filter(region=="TX")

 key_events_fltr <- key_events %>%
      filter(!str_detect(event,"Stimulus"))
    
    dates <- key_events_fltr$date
    events <- key_events_fltr$event
    
    plotLines <- map2(key_events_fltr$date,key_events_fltr$event,
                      ~list(label = list(text = .y,
                                         style = list(color = "rgba(0, 0, 0, 0.6)", 
                                                      fontSize='12px',textTransform='initial')),
                            color = "rgba(0, 0, 0, 0.6)",
                            width = 1,
                            dashStyle = "Dash",
                            value = datetime_to_timestamp(as.Date(.x, tz="UTC"))))
    
   myMenuItems <- c("downloadPNG", "downloadJPEG", "downloadPDF", "downloadCSV" )
    
   r_naught %>% 
      hchart("line", hcaes(x = date, y = mean), animation=FALSE,
             tooltip = FALSE,
             threshold = 1, color = "#F26852", negativeColor = "#FFD100") %>%
      hc_add_series(r_naught, type = "arearange",
                    hcaes(x = date, low = lower_80,
                          high = upper_80),
                    threshold = 1, color = "#F26852", negativeColor = "#FFD100",
                    linkedTo = "r_naught") %>%
      hc_plotOptions(arearange = list(fillOpacity=.3)) %>%
      hc_title(
        text ="Texas Effective Reproduction Rate · R<sub>t</sub>",
        useHTML = TRUE) %>% 
      hc_subtitle(
        text ="From R<sub>t</sub> Live: R<sub>t</sub>  is the average number of people who become infected by an infectious person.</br></br><span style='color: #F26852'>If it’s above 1.0, COVID-19 will spread quickly.</span> <span style='color: #FFD100'>If it’s below 1.0, infections will slow.</span>",
        useHTML = TRUE) %>%
      hc_yAxis(title = list(text="Effective Reproduction Rate (R<sub>t</sub>)"),
               min = min(r_naught$lower_80), 
               max = max(r_naught$upper_80)) %>% 
      hc_xAxis(title=NULL,
               plotLines = plotLines) %>% 
      hc_tooltip(table = FALSE, sort = FALSE,
                 pointFormat = "Effective Reproduction Rate · R<sub>t</sub>: {point.mean:,.2f}<br>") %>% 
      hc_credits(
        enabled = TRUE,
        text = "Source: rt.live Analysis",
        href = "https://rt.live") %>%
      hc_add_theme(tx2036_hc) %>% 
       hc_exporting(enabled=TRUE,
        buttons = list(contextButton = list(menuItems = myMenuItems)))
   
   
    
```

```{r}
library(tidyverse)
library(httr)
library(highcharter)
library(jsonlite)
library(geojsonio)

atx_covid_zips_cases <- read_csv("https://opendata.arcgis.com/datasets/4d913cdf3d894c3898696a7216e44180_02.csv") %>% 
  clean_names() %>% 
  mutate(zipcode=as.character(zipcode))

atx_zips_by_cases_sf <- atx_covid_zips_cases %>%
  left_join(tx_zips, by=c("zipcode"="GEOID10")) %>% 
  select(zipcode, count, geometry) %>% 
  st_as_sf()

geo_zips_travis <- sf_geojson(atx_zips_by_cases_sf)
# is text

geo_zips_travis <- jsonlite::fromJSON(geo_zips_travis, simplifyVector = FALSE)
# stops <- color_stops(n = 10, colors = c("#3A4A9F", "#FFFFFF", "#F26852"))

austin_geo_json <- geojsonio::geojson_read(x="https://chronicdata.cdc.gov/resource/6vp6-wxuq.geojson",parse = TRUE)

highchart() %>%
  hc_add_series(mapData = austin_geo_json, showInLegend = FALSE, nullColor = "#7d7d7d",
                borderWidth = 0)# %>%
  hc_add_series_map(geo_zips_travis,atx_covid_zips_cases, value = "count", joinBy = "zipcode", name = "COVID-19 in Austin") %>% 
  hc_title(
    text ="Texas Effective Reproduction Rate · R<sub>t</sub>",
    useHTML = TRUE) %>% 
  hc_subtitle(
    text ="From R<sub>t</sub> Live: R<sub>t</sub>  is the average number of people who become infected by an infectious person.",
    useHTML = TRUE) %>%
  hc_tooltip(table = FALSE, sort = FALSE,
             pointFormat = "Zip: {point.zipcode}<br>Confirmed Cases: {point.count:,.0f}") %>% 
  hc_credits(
    enabled = TRUE,
    text = "Source: rt.live Analysis",
    href = "https://rt.live") %>%
   hc_add_theme(tx2036_hc) %>%
   hc_colorAxis(minColor = "#f7fbff", maxColor = "#08306b") %>% 
   hc_exporting(enabled=TRUE,
                buttons = list(contextButton = list(menuItems = myMenuItems)))
                buttons = list(contextButton = list(menuItems = myMenuItems))) %>% 
   hc_size(height = 650)

ausgeojson <- GET("https://chronicdata.cdc.gov/resource/6vp6-wxuq.geojson") %>%
  content() #%>%
  # fromJSON(simplifyVector = FALSE)# %>%
  # as.json()

ausmap <- highchart(type = "map") %>%
  hc_add_series_map(mapData = ausgeojson, showInLegend = FALSE)
ausmap
```

# Next Blog Post Content

```{r hc_theme}
mworth_hc <- hc_theme_merge(
  hc_theme_smpl(),
  hc_theme(chart = list(backgroundColor = "#fff", 
                        style = list(fontFamily = 'Roboto', 
                                     fontSize = "28px",  fontWeight = "bold",
                                     color="#4d4d4d", textTransform="initial")),
           title = list(style = list(fontFamily = 'Roboto', 
                                     fontWeight="bold",
                                     color="#2d2d2d"),
                        align = "left"), 
           subtitle = list(style = list(fontFamily = 'Roboto',
                                        color="#7d7d7d",
                                        textTransform="initial",
                                        fontWeight="400",
                                        fontSize = "14px"),
                           align = "left"), 
           legend = list(align = "right", 
                         style = list(fontFamily = 'Roboto', color="#6d6d6d"),
                         itemStyle = list(fontFamily = 'Roboto', color = '#6d6d6d'),
                         itemHoverStyle = list(color = 'gray'),   
                         verticalAlign = "top"),
           credits = list(style = list(color = "#fff")),
           xAxis = list(labels =list(style = list(fontFamily = 'Roboto', color="#2d2d2d")), 
                        title = list(style = list(color = "#4d4d4d", fontSize = "12px", 
                                                  color="#4d4d4d",fontWeight="500")),
                        gridLineWidth = 0,
                        gridLineColor = "#9d9d9d", 
                        lineColor = 'rgba(0,0,0,0.7)', 
                        minorGridLineColor = 'rgba(0,0,0,0.7)', 
                        tickColor = "#9d9d9d", 
                        tickWidth = 1), 
           yAxis = list(labels =list(style = list(fontFamily = 'Roboto', color="#2d2d2d")), 
                        title = list(style = list(color = "#fff", fontSize = "12px", 
                                                  color="#fff",fontWeight="500")), 
                        gridLineWidth = .5,
                        gridLineColor = 'rgba(0,0,0,0.15)', 
                        lineColor = 'rgba(0,0,0,0.15)', 
                        minorGridLineColor = 'rgba(0,0,0,0.15)', 
                        tickColor = "#9d9d9d", 
                        tickWidth = 2)))
```

```{r include=FALSE}
I35 <- st_read("spatial/I35_HighwayATX.shp") %>% 
  st_transform(crs = 4326)

arterials <- st_read("spatial/arterials/CENART.shp") %>% 
  st_transform(crs = 4326) %>% 
  filter(NAME != "IH 35",
         str_detect(TYPE, "HWY|BLVD"),
         SIZE == "MAJOR")

capcog <- st_read("spatial/CAPCOG_Counties.shp") %>% 
  st_transform(crs = 4326) %>% 
  filter(COUNTY != "TRAVIS")

img <- readPNG("spatial/I35.png")

tx_zips <- tigris::zctas(state="TX",cb=TRUE) 

sf_counties <- tigris::counties(state="TX") %>% filter(GEOID=="48453")
```


## Risk, Resilience, + COVID-19

Looking next at _who_ should be most concerned about getting COVID-19, [this website](https://www.cdc.gov/coronavirus/2019-ncov/need-extra-precautions/people-with-medical-conditions.html) from the CDC documents known factors that would make someone "**at increased risk**" of developing a severe illness from COVID-19 and other conditions that might put someone at an increased risk. We can use this list and some related datasets that the CDC publishes elsewhere to understand Of the known and probable factors for putting you at increased risk of developing a severe illness, the CDC has very detailed data from 2017 for four of the known factors. the US Census has incorporated three of these factors as part of a new [Community Resilience](https://www.census.gov/data/experimental-data-products/community-resilience-estimates.html) they just launched at the end of June. This dataset attempts to illustrate which communities are most likely and least likely to endure a disaster of any kind. 

::: l-body-outset
| Risk Level                                   | Conditions                                                                                        |
| :------------------------------------------- | :------------------------------------------------------------------------------------------------ |
| **Known To Increase Risk of Severe Illness** | Cancer, COPD, Chronic kidney disease, Type 2 diabetes mellitus, Obesity, & Coronary Heart Disease |
| **Might Increase Risk of Severe Illness**    | Asthma, Smoking, & High blood pressure                                                            |
:::

We can with conditions, we can map these out and get a general sense of where people are at risk of developing a severe illness if they get COVID-19.  



#### Who is dying most often from COVID-19?

In addition to this list, there are demographic data we can use to assess which groups are dying most often from COVID-19 in Austin. Given that Austin is in Texas, we can use statewide data collected from death certificates to get a broader understanding of who is dying most often from COVID-19. However, we'll also need to compare those numbers with statewide demographic data from the Census Bureau to assess which groups are experiencing death at unusually high rates. The only exception to this age data, given that it's widely known that COVID-19 is particularly fatal for the population aged 65 and older, which in Texas accounts for 71% percent of all deaths. It's worth noting if you go back to ages 50 and older account, the share of deaths jumps up to 92% for statewide deaths. For now, however, now we'll stick to the population aged 65 and older. We'll include that in the list, but to get other factors, we'll have to compare deaths to the population:

```{r process demographic data, include=FALSE}
dshs_state_ages <- read_excel(lcl, sheet = "Cases by Age Group", skip=1) %>% 
  clean_names() %>% 
  select(group=age_groupings, cases=number, pct=3) %>% 
  filter(!is.na(cases),
         group!="Total") %>% 
  mutate(cases=as.numeric(cases),
         report_type="cases",
         pct=as.numeric(pct),
         demographic_type="ages")
  
dshs_state_gender <- read_excel(lcl, sheet="Cases by Gender", skip=1) %>% 
  clean_names() %>% 
  select(group=gender, cases=number, pct=percent) %>% 
  filter(!is.na(cases),
         group!="Total") %>% 
  mutate(cases=as.numeric(cases),
         report_type="cases",
         pct=as.numeric(pct),
         demographic_type="gender")

dshs_state_race <- read_excel(lcl, sheet="Cases by RaceEthnicity", skip=1) %>% 
  clean_names() %>% 
  # select(group=race_ethnicity, cases=number, pct=percent) %>% 
  select(group=race_ethnicity, cases=number, pct=3) %>% 
  filter(!is.na(cases),
         group!="Total") %>%   
  mutate(pct=gsub("%","",x=pct)) %>% 
  mutate(cases=as.numeric(cases),
         report_type="cases",
         pct=as.numeric(pct),
         demographic_type="race")

dshs_state_ages_fates <- read_excel(lcl, sheet = "Fatalities by Age Group", skip=1) %>% 
  clean_names() %>% 
  select(group=age_groupings, cases=number, pct=3) %>% 
  filter(!is.na(cases),
         group!="Total") %>% 
  mutate(cases=as.numeric(cases),
         report_type="fatalities",
         pct=as.numeric(pct),
         demographic_type="ages")
  
dshs_state_gender_fates <- read_excel(lcl, sheet = "Fatalities by Gender", skip=1) %>% 
  clean_names() %>% 
  select(group=gender, cases=number, pct=percent) %>% 
  filter(!is.na(cases),
         group!="Total") %>% 
  mutate(cases=as.numeric(cases),
         report_type="fatalities",
         pct=as.numeric(pct),
         demographic_type="gender")

dshs_state_race_fates <- read_excel(lcl, sheet = "Fatalities by Race-Ethnicity", skip=1) %>% 
  clean_names() %>% 
  select(group=race_ethnicity, cases=number, pct=percent) %>% 
  filter(!is.na(cases),
         group!="Total") %>% 
  
  mutate(cases=as.numeric(cases),
         report_type="fatalities",
         pct=as.numeric(pct),
         demographic_type="race")

dshs_demographic_data <- bind_rows(dshs_state_ages,
                                   dshs_state_gender,
                                   dshs_state_race,
                                   dshs_state_ages_fates,
                                   dshs_state_gender_fates,
                                   dshs_state_race_fates) %>% 
  select(4,5,1,everything())  %>% 
  mutate(state="Texas",
         # pct=pct/100,     ##NOTE: Comment Out/In As Needed Depending on Format of "pct" column
         fips="48") %>% 
  select(state,fips,everything()) %>%
  rename(count=cases)
```

```{r layout="l-page", fig.height=4.5, fig.width=11}

vars <- load_variables(2018,"acs5/profile", cache=TRUE)

demvars <-  c(White = "B02001_002",
              Black = "B02001_003",
              Asian = "B02001_005",
              Hispanic = "B03001_003",
              Male = "B01001_002",
              Female = "B01001_026")

dem_pop_data <- get_acs(geography = "state", variables = demvars,
                  state = "TX", geometry = FALSE,
                  summary_var = "B01003_001") %>% 
  mutate(pop_pct = round(estimate/summary_est, digits=4)) %>% 
  select(state=NAME, group=variable, pop_pct)

fatality_data <- dshs_demographic_data %>% 
  filter(report_type=="fatalities" & demographic_type != "ages" & group!="Unknown" & group!="Other") %>% 
  left_join(dem_pop_data, by="group") %>% 
  mutate(excess_death = pop_pct-pct)

ann_filtr1 <- data.frame(group = "Hispanic", pct= .455, lab = "Text",
                       demographic_type = factor("Race",levels = c("Gender","Race")))
ann_filtr2 <- data.frame(group = "Hispanic", pct= .2, lab = "Text",
                       demographic_type = factor("Race",levels = c("Gender","Race")))

ann_filtr3 <- data.frame(group = "Male", pct= .545, lab = "Text",
                       demographic_type = factor("Gender",levels = c("Gender","Race")))
ann_filtr4 <- data.frame(group = "Male", pct= .25, lab = "Text",
                       demographic_type = factor("Gender",levels = c("Gender","Race")))
fatality_data %>% 
  mutate(demographic_type=str_to_title(demographic_type)) %>% 
  ggplot(aes(y=reorder(group, pct), x=pct)) +
  geom_bar(aes(fill=demographic_type), stat="identity", na.rm=TRUE, width=.9) +
  geom_bar(aes(y=reorder(group, pct), x=pop_pct), fill="#e5e5e5", color = "#3d3d3d", 
           alpha=.6, lwd = .5, linetype = 2, stat="identity", na.rm=TRUE, width=.9) +
  geom_text(data=ann_filtr1, aes(label="Deaths"), color="white", family = "Gotham Bold") +
  geom_text(data=ann_filtr2, aes(label="Population Share"), color="#3d3d3d", family = "Gotham Bold") +
  geom_text(data=ann_filtr3, aes(label="Deaths"), color="white", family = "Gotham Bold") +
  geom_text(data=ann_filtr4, aes(label="Population Share"), color="#3d3d3d", family = "Gotham Bold") +
  hrbrthemes::theme_ipsum(base_family = "Gotham Book", base_size=10) +
  hrbrthemes::scale_x_percent() +
  ggthemes::scale_fill_economist() +
  labs(title = "Men, Hispanics, and Black Texans Are Disproportionately Dying From COVID-19",
       subtitle = "Bordered Opaque Boxes = Share of Population | Bars in Full Color = Deaths from COVID-19",
       caption = "SOURCE: Texas Department of State Health Services\nDATA: 'Accessible Dashboard Data'\nURL:https://www.dshs.state.tx.us/coronavirus/additionaldata/",
       y = NULL, x=NULL) +
  ggforce::facet_col(~demographic_type, 
                     scales = 'free_y',
                     space = 'free', 
                     strip.position = 'top')+
  theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, unit = "cm"),
        plot.title = element_text(family="Gotham-Black", size=16),
        plot.subtitle = ggtext::element_markdown(size=12),
        plot.caption = element_text(family="Gotham-Light", hjust="0"),
        strip.text = element_text(family="Gotham-Ultra", color = "#8d8d8d"),
        panel.spacing = unit(1, "lines"),
        axis.title.y = element_blank(),
        legend.position = "none")

```

#### What may increase your risk of being exposed to COVID-19?

In total right now, we now have 7 things things that either put you at risk for developing a severe illness (_Cancer, Chronic kidney disease, COPD, and Type 2 Diabetes_) or classify as groups within Texas that disproportionately fall victim to COVID-19 (. If we consider things that may increase your risk of exposure, we'll be able to get a look at Austin and determine where folks live who higher risk of exposure, a higher risk of developing a severe illness from COVID-19, or are in a group that is disproportionately dying from COVID-19.

For determining who is at risk of exposure, we can look at actions that decrease exposure--such as staying home more than usual or working from home--but it's probably better to consider what things enable those actions. For that, we look at having a fast and reliable internet connection at home, which has been highlighted as a major factor in navigating COVID-19[^1] and something that can decrease the risk of exposure[^2][^3] to COVID-19. If you do have a good internet connection, you can order groceries online, work from home if your employer allows, or you take classes online[^4]. If you don't, you can't afford to just stay home---even if you wanted to---and social distancing becomes complicated if everyone in your community also doesn't have good internet access. To do anything or meet your needs, you would have to do pretty much everything in person---from grocery shopping to accessing basic health care. This excerpt from a Forbes interview with a 911 Coordinator in Kentucky explains the challenges for rural Appalachians navigating COVID-19 without internet:

> “One of the biggest issues that we face in rural Appalachia is a lack of broadband and internet connectivity,” says Graham. “You hear so much about people telecommuting or using telehealth services, but that's not an option for a lot of rural Americans. We don't have the connectivity to do that even if we had the kind of jobs that allowed it.”[^5]

That said, having a sufficient broadband internet connection will also be considered in our list. Because if you're at high-risk of developing a severe illness from COVID-19 or are in a group that is disproportionately dying from COVID, having a good internet would enable you to reduce your risk of being exposed. 

```{r layout="l-page", fig.height=4.5}
broadband_adoption_travis <- get_acs(geography = "tract", variables = "DP02_0152P",
                           state = "TX", county = "Travis County", geometry = TRUE) %>% 
  clean_names()

broadband_access_travis <- vroom("fcc_tract_advertised_data.csv") %>% 
  mutate(geoid=as.character(geoid))

broadband_travis <- broadband_adoption_travis %>% 
  left_join(broadband_access_travis, by="geoid") %>% 
  select(geoid, broadband_adoption=estimate, broadband_access=with, geometry) %>% 
  mutate(broadband_access=round(broadband_access*100, digits=2)) %>% 
  pivot_longer(cols = starts_with("broadband"), names_to="broadband_type", values_to = "value") %>% 
  select(geoid, broadband_type, value, geometry) %>% 
  st_as_sf() %>% 
  st_transform(4326)
  

st_bbox(broadband_travis)

groups <- unique(broadband_travis$broadband_type)
names <- c("broadband_adoption"="Adoption Rates", "broadband_access"="Access Rate")
colors <- c("#56B1F7", "#56B1F7")
captions <- c("Data: Community Resilience Estimates\nSource: U.S. Census Bureau. 2020.", "Data: Advertised Fixed Broadband Deployment\n Source: FCC Form 477 (June 2019, v1 Release)")

plots <- pmap(list(groups, names, colors, captions), function(groups, names, colors, captions){
    broadband_travis %>% 
      filter(broadband_type==groups) %>% 
      ggplot() +
      geom_sf(aes(fill=value), 
              color = "#eceff1",
              lwd=.1) +
      geom_sf(data = capcog, color = "#2d2d2d", fill="#f5f5f5") +
      geom_sf(data = arterials, color = "#6d6d6d", lwd = .1) +
      geom_sf(data = I35, color = "red") +
      scale_fill_gradientn(colours = tinter(colors, steps = 10), 
                           labels = function(x) paste0(x,"%")) +
      scale_size(guide = "legend") +
      hrbrthemes::theme_ipsum(base_family = "Graphik Regular", base_size = 8) +
      theme(legend.position = "bottom",
            plot.margin = unit(c(0,3,0,3), "pt"),
            plot.caption = element_text(family = "Graphik Regular", hjust = 0.5, size=6,
                                        margin = unit(c(-1,0,10,0), "pt")),
            plot.title = element_text(family = "Graphik Bold", hjust = 0.5, size=10),
            plot.subtitle = element_text(color="red", family = "Graphik Regular", hjust = 0.5, size=7,
                                         margin = unit(c(-6,0,6,0), "pt"))) +
      coord_sf(datum=NA, xlim=c(-98.17298, -97.36954), ylim=c(30.02450, 30.62825), expand = FALSE) +
      labs(title=names,
           subtitle = "I-35 = Road in Red",
           caption=captions,
           fill=NULL) +
      guides(fill = guide_colourbar(barwidth = 7, barheight = .5, direction="horizontal", nbin = 10,
                                    draw.ulim = TRUE, draw.llim = TRUE, frame.colour = "black", 
                                    frame.linewidth = 0.5, frame.linetype = 1),
             colour = FALSE)})


(plots[[1]] | plots[[2]]) +
  plot_annotation(title = 'The Landscape of Broadband Access + Adoption in Travis County',
                  subtitle = "Austin's urban core has the highest access,\nbut east and southeast Travis county has a noticeable gap in adoption.",
                  theme = theme(plot.title = element_text(size = 16, hjust = 0.5, family = "Graphik Bold"),
                                plot.subtitle = element_text(size = 10, hjust = 0.5, family = "Graphik Light",
                                                          margin = unit(c(0,0,10,0), "pt")),
                                plot.caption = element_text(size = 8, hjust = 0.5, family = "Graphik Regular"),
                                plot.margin = unit(c(5,0,0,0), "pt")))
```


[^1]: NW, 1615 L. St, Suite 800Washington, & Inquiries, D. 20036USA202-419-4300 | M.-857-8562 | F.-419-4372 | M. (2020, April 30). 53% of Americans Say the Internet Has Been Essential During the COVID-19 Outbreak. Pew Research Center: Internet, Science & Tech. https://www.pewresearch.org/internet/2020/04/30/53-of-americans-say-the-internet-has-been-essential-during-the-covid-19-outbreak/  
[^2]: Chiou, L., & Tucker, C. (2020). Social Distancing, Internet Access and Inequality (Working Paper No. 26982). National Bureau of Economic Research. https://doi.org/10.3386/w26982  
[^3]: How limited broadband affects older adults during COVID-19. (2020, March 26). Center on Rural Innovation (CORI). https://ruralinnovation.us/covid19-broadband-health-care/  
[^4]: Jechow, A. (n.d.). Austin ISD Is Rolling Out 110 Buses Equipped With Wi-Fi For Neighborhoods With Limited Online Access. Retrieved August 12, 2020, from https://www.kut.org/post/austin-isd-rolling-out-110-buses-equipped-wi-fi-neighborhoods-limited-online-access  
[^5]: Estes, C. (n.d.). How The COVID-19 Coronavirus Pandemic Is Impacting Rural America. Forbes. Retrieved August 12, 2020, from https://www.forbes.com/sites/claryestes/2020/03/17/coronavirus-and-rural-america/

</details>

<details>
  <summary><strong>Policy Impacts | </strong>Urban Texas</summary>

At veto and remember you gotta win Friday night to make the playoffs. I guess we're fixin' to find out. Lemme tell you something. I'll tell you what. Tonight is your night. You have an opportunity to go out there and accept the challenge. You have the opportunity to be a part of the team. If anybody's internal, I'm internal. I'm not here to make friends. This ain't my home. This ain't my school. It never will be. Moby Dick is actually the perfect metaphor for this town. You need to learn this offense, son. If you look at a girl like a geometry proof the answer is right in front of you. It's your job to find the missing variable. You gotta solve for x. Yeah, um, that's actually algebra. That's actually not the point. Do you understand? My truck ain't running. I don't hate you, Lyla. It'd be a lot easier if I did. All right, listen up. You're a lousy ping-pong player. He's all bard and no bite. Oh, hell. Take a knee. Alright, y'all. Today we're champions. Feels good, right? Enjoy it while it lasts, 'cause tomorrow we're targets.

Dillon Ipsum I'll tell you something else and don't you ever forget this. I'm starting to feel like I have some sort of repellent that repels females away and sends them running. I don't want to step on your fingers or anything but you might want to slice those a little thinner because cucumber sandwiches are pretty delicate. Did I just lose a lot of man points for that? Crucifictorious. You can't fake boosterism, Eric, it comes from the heart. That's the beauty of it. Yeah, when we drive on the football field...we usually don't drive on our football field. Lyla, your dad's a sinner, I'm a weak man, but it was one mistake. He's one of those "I'll tell you something" guys, isn't he? Hey look, y'all keep tryin', but you ain't gonna catch me. Hey, don't hate, accelerate! Now, for as long as I know Tim Riggins, there's only two phrases that can put a smile on his face. Number 1: We're going to State. And Number 2: The results are in - you are not the father. Texas forever.

</details>

### Mapping These Factors in Austin

Looking at Austin, the question is: _where do all these factors collide?_ Where are people at risk of exposure because they don't have sufficient access to internet or low adoption rates? Where do black, hispanic, and male Austinites mostly reside? And where do Austinites with health conditions that can increase their risk of developing a severe illness from COVID-19 live?

```{r echo=FALSE, fig.height=4.5, layout="l-page"}

# ts_county_cases <- read.socrata("https://chronicdata.cdc.gov/resource/6vp6-wxuq.csv")

ts_county_cases <- read_csv("cdc_500_cities_atx.csv")

counties <- c("Travis", "Bastrop", "Williamson", "Hays")

aus_tracts <- map_df(counties, 
                       ~tigris::tracts(state="TX", county=.x), id="county")

aus_tract_data <- ts_county_cases %>% 
  as_tibble() %>% 
  filter(stateabbr=="TX",
         cityname=="Austin",
         year=="2017",
         # categoryid=="HLTHOUT",
         geographiclevel=="Census Tract") %>% 
  filter(str_detect(short_question_text, "COPD|Cancer|Kidney|Diabetes|Obesity|Smoking|Asthma|High Blood Pressure|Coronary Heart Disease")) %>%
  mutate(tractfips=as.character(tractfips))
# 
# aus_tract_data_csv <- aus_tract_data %>%
#   write_csv("cdc_500_cities_atx.csv")

atx_zips_by_cases_sf <- aus_tract_data %>%
  dplyr::left_join(aus_tracts, by=c("tractfips"="GEOID")) %>% 
  dplyr::select(1:5,tractfips,tract_name=NAMELSAD,short_question_text,category, measure, data_value, data_value_unit,geometry) %>%
  rename(`Tract Name`=tract_name,`Topic`=short_question_text) %>% 
  mutate(`Data Value`=paste0(data_value, data_value_unit)) %>% 
  drop_na(data_value) %>% 
  sf::st_as_sf() %>% 
  st_transform(crs="ESRI:102339")

tmap_mode("plot")

tm_shape(atx_zips_by_cases_sf, bbox=atx_zips_by_cases_sf, unit="miles") +
  tm_fill("data_value", 
          title = "% of Population",
          legend.format = lst(suffix="%"),
          legend.hist = FALSE,
          palette = tinter("#56B1F7", steps = 5),
          fontfamily = "Gotham Book") +
  tm_facets(by="Topic",
            free.scales = TRUE) +
# tm_shape(atx_zips_by_cases_sf) + 
#   tm_borders(col = "#9d9d9d", lwd = .3, lty = "solid") +
tm_shape(sf_counties) +
  tm_borders(lwd = 2) +
tm_shape(I35, name = "I-35") +
  tm_lines(lwd = 3, col = "NAME",  palette="#d73a49", title.col="Streets") +
tm_shape(arterials) +
  tm_lines(lwd = .5) +
  tm_compass(type = "arrow",
             size= 1, bg.alpha = .6,
             color.dark = "#9d9d9d",
             position = c("right", "TOP")) +
  tm_scale_bar(color.dark = "gray60",
               size = .5,
               breaks = c(0,5,10),
               position = c("right", "bottom")) +
  tm_layout(main.title = "COVID-19 High-Risk Chronic Health Condition Prevalence",
            main.title.size = 1.2,   
            main.title.fontfamily  = "Gotham Ultra",
            main.title.position = c("center", "top"),
            fontfamily = "Gotham Narrow Book",
            legend.outside = FALSE,
            legend.position = c("left", "bottom"),
            legend.title.fontfamily  = "Gotham Narrow Black",
            legend.title.size = .7,
            legend.text.size = .5,
            legend.frame =  TRUE,
            legend.bg.color = "white",
            panel.label.size = 1, 
            panel.label.fontfamily = "Gotham Light",
            panel.label.color = 'white',
            panel.label.bg.color = '#4d4d4d', 
            panel.label.height = 1.1,
            attr.outside = FALSE,
            asp = 0,
            bg.color = "transparent",
            inner.margins=c(.04,.03, .02, .01), 
            frame=FALSE) +
    tm_credits(text = "Data: CDC 500 Cities Project | Map: Matt Worthington ", 
             bg.color = "white",
             bg.alpha = NA,
             fontfamily = "Gotham Book",
             align= "right",
             position = c("RIGHT", "BOTTOM"),
             size = .3)

```

```{r echo=FALSE, fig.height=3, layout="l-page"}
demvars <-  c(White = "B02001_002",
              Black = "B02001_003",
              Asian = "B02001_005",
              Hispanic = "B03001_003",
              Male = "B01001_002",
              Female = "B01001_026")

travis <- get_acs(geography = "tract", variables = demvars,
                  state = "TX", county = "Travis County", geometry = TRUE,
                  summary_var = "B01003_001") %>% 
  mutate(pop_pct = round(100* estimate/summary_est, digits=2))

travis_race <- travis %>%
  filter(!str_detect(variable,"Female|Asian|White"))

bbox_new <- st_bbox(travis_race)

tm_shape(travis_race, bbox=atx_zips_by_cases_sf, unit="miles") +
  tm_fill("pop_pct",
          title = "% of Population",
          # breaks ="equal", 
          legend.hist = FALSE,
          palette = tinter("#5da5da", steps = 5),
          fontfamily = "Gotham Book") +
  tm_facets(by="variable", ncol = 3,
            free.scales = TRUE) +
  # tm_shape(travis_race, bbox=travis_race) +
  # tm_borders(col = "#f5f5f5", lwd = .3, lty = "solid") +
tm_shape(sf_counties, bbox=bbox_new) +
  tm_borders(lwd = 2) +
tm_shape(I35, bbox=bbox_new, name = "I-35") +
  tm_lines(col = "NAME",  
           lwd = 3, 
           palette="#d73a49", 
           title.col="Streets") +
tm_shape(arterials, bbox=bbox_new) +
  tm_lines(lwd = .5) +
  tm_compass(type = "arrow",
             size= 1, bg.alpha = .6,
             color.dark = "#9d9d9d",
             position = c("right", "top")) +
  tm_scale_bar(color.dark = "gray60", 
               breaks = c(0,5,10),
               position = c("right", "bottom")) + 
  tm_layout(main.title = "COVID-19 High-Fatality Populations in Austin",
            main.title.size = 1.2,   
            main.title.fontfamily  = "Gotham Ultra",
            main.title.position = c("center", "top"),
            fontfamily = "Gotham Narrow Book",
            legend.outside = FALSE,
            legend.position = c("left", "bottom"),
            legend.title.fontfamily  = "Gotham Narrow Black",
            legend.title.size = .6,
            legend.text.size = .4,
            legend.height = .4,
            legend.frame =  TRUE,
            legend.bg.color = "white",
            panel.label.size = 1, 
            panel.label.fontfamily = "Gotham Light",
            panel.label.color = 'white',
            panel.label.bg.color = '#4d4d4d', 
            panel.label.height = 1.1,
            attr.outside = FALSE,
            asp = 0,
            legend.stack = "vertical",
            bg.color = "transparent",
            inner.margins=c(.04,.03, .02, .01), 
            frame=FALSE) +
    tm_credits(text = "Data: Austin Public Health | Map: Matt Worthington ", 
             bg.color = "white",
             bg.alpha = NA,
             fontfamily = "Gotham Book",
             align= "right",
             position = c("RIGHT", "BOTTOM"),
             size = .3)
```

```{r, layout="l-page"}
travis_age_df <- get_acs(geography = "tract", variables = "DP05_0030P",
                        state = "TX", county = "Travis County", geometry = TRUE)

aus_tracts <- aus_tracts %>% 
  rename(state=1, county=2, tract=3)

travis_risk_resilience <- vroom("https://www2.census.gov/data/experimental-data-products/community-resilience-estimates/2020/cre-2018-a11.csv") %>% 
  filter(state=="48" & county =="453") %>% 
  left_join(aus_tracts, by=c("state","county","tract")) %>% 
  st_as_sf() %>% 
  st_transform(crs=4326)

st_bbox(travis_risk_resilience)

groups <- unique(travis_risk_resilience$rfgrp)
names <- c("0RF"="Zero Risk Factors", "1-2RF"="1-2 Risk Factors", "3PLRF"="3+ Risk Factors")
colors <- c("#56B1F7", "#56B1F7", "#56B1F7")

plots <- pmap(list(groups, names, colors), function(groups, names, colors){
    travis_risk_resilience %>% 
      filter(rfgrp==groups) %>% 
      ggplot() +
      geom_sf(aes(fill=predrt), 
              color = "#eceff1",
              lwd=.1) +
      geom_sf(data = capcog, color = "#2d2d2d", fill="#f5f5f5") +
      geom_sf(data = arterials, color = "#6d6d6d", lwd = .1) +
      geom_sf(data = I35, color = "red") +
      scale_fill_gradientn(colours = tinter(colors, steps = 10), 
                           # limits = c(0,85),
                           labels = function(x) paste0(x,"%")) +
      scale_size(guide = "legend") +
      hrbrthemes::theme_ipsum(base_family = "Graphik Regular", base_size = 8) +
      theme(legend.position = "bottom",
            plot.margin = unit(c(0,3,0,3), "pt"),
            plot.title = element_text(family = "Graphik Bold", hjust = 0.5, size=10)) +
      coord_sf(datum=NA, xlim=c(-98.17298, -97.36954), ylim=c(30.02450, 30.62825), expand = FALSE) +
      labs(title=names,
           fill=NULL) +
      guides(fill = guide_colourbar(barwidth = 7, barheight = .5, direction="horizontal", nbin = 10,
                                    draw.ulim = TRUE, draw.llim = TRUE, frame.colour = "black", 
                                    frame.linewidth = 0.5, frame.linetype = 1),
             colour = FALSE)})

library(patchwork)

(plots[[1]] | plots[[2]] | plots[[3]]) +
  plot_annotation(title = 'Bouncing Back From A Disaster is Complicated East of I-35',
                  subtitle = 'Community Resilience Estimates measure the ability of\na population to recover from the impacts of disasters.',
                  caption = 'Source: Community Resilience Estimates, U.S. Census Bureau. 2020.',
                  theme = theme(plot.title = element_text(size = 16, hjust = 0.5, family = "Graphik Bold"),
                                plot.subtitle = element_text(size = 10, hjust = 0.5, family = "Graphik Light",
                                                          margin = unit(c(0,0,10,0), "pt")),
                                plot.caption = element_text(size = 8, hjust = 0.5, family = "Graphik Regular"),
                                plot.margin = unit(c(0,0,0,0), "pt")))
```

```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE, layout="l-page"}

ts_county_cases <- read.socrata("https://chronicdata.cdc.gov/resource/6vp6-wxuq.csv") 

counties <- c("Travis", "Bastrop", "Williamson", "Hays")

aus_tracts <- map_df(counties, 
                       ~tigris::tracts(state="TX", county=.x), id="county")

aus_tract_data <- ts_county_cases %>% 
  as_tibble() %>% 
  filter(stateabbr=="TX",
         cityname=="Austin",
         year=="2017",
         categoryid=="HLTHOUT",
         geographiclevel=="Census Tract") %>% 
  mutate(tractfips=as.character(tractfips))

atx_zips_by_cases_sf <- aus_tract_data %>%
  dplyr::left_join(aus_tracts, by=c("tractfips"="GEOID")) %>% 
  dplyr::select(1:5,tractfips,tract_name=NAMELSAD,short_question_text,category, measure, data_value, data_value_unit,geometry) %>%
  rename(`Tract Name`=tract_name,`Topic`=short_question_text) %>% 
  mutate(`Data Value`=paste0(data_value, data_value_unit)) %>% 
  drop_na(data_value) %>% 
  sf::st_as_sf() %>% 
  st_transform(crs="ESRI:102339")

# flextable part -----
fun_flextable <- function(dat){
  ft <- flextable(dat, col_keys = c("Tract Name", "Topic", "Data Value"), 
                  defaults = list(fontname = "Roboto"), 
                  theme_fun = theme_vanilla)
  ft <- fontsize(ft, part = "all", size = 20)
  ft <- bold(ft, part = "header", bold = TRUE)
  ft <- color(ft, color = "black", part = "all")
  ft <- set_table_properties(ft, layout = "autofit")
  as.character(htmltools_value(ft))
}
temp_dat <- as.data.frame(atx_zips_by_cases_sf)[,c("Tract Name", "Topic", "Data Value")]
temp_dat <- split(temp_dat, seq_len(nrow(temp_dat)))
atx_zips_by_cases_sf$tooltip <- map_chr(temp_dat, fun_flextable)
# end of flextable part

tx_map <- atx_zips_by_cases_sf %>%
  ggplot() +
  geom_sf(aes(fill=data_value), color="#6d6d6d", lwd=.3) +
  # geom_sf_interactive(aes(fill=data_value, tooltip=tooltip, data_id = tractfips), color="#6d6d6d", lwd=.3) +
  # geom_sf(data=sf_counties, color="#1d1d1d", fill=NA, lwd=1) +
  scale_fill_gradientn(colours = tinter("#5da5da", steps = 5), labels = function(x) paste0(x,"%")) +
  coord_sf(datum=NA) +
  facet_wrap(~Topic, scales = "free")+
  hrbrthemes::theme_ipsum_es(base_family="Roboto") +
  theme(plot.title = element_text(family="Roboto", face = "bold"),
        plot.subtitle = element_text(family="Roboto", face = "plain"),
        plot.caption = element_text(family="Roboto", face = "plain")) + 
  labs(title="The Health of Austin's Metro Area Favors Those West of I-35",
       subtitle="Data: The 500 Cities Project: Local data for Better Health | Year - 2017",
       caption="SOURCE: Austin Public Health")

g <- purrr::map(atx_zips_by_cases_sf$Topic,
           function(x) {
             ggplot() +
               geom_sf(data = filter(atx_zips_by_cases_sf, Topic == x), aes(fill=data_value), color="#6d6d6d", lwd=.3) +
               hrbrthemes::theme_ipsum_es(base_family="Roboto") +
               coord_sf(datum=NA) +
               scale_fill_gradientn(colours = tinter("#5da5da", steps = 5), labels = function(x) paste0(x,"%")) +
               # guides(fill = FALSE) +
               ggtitle(x)
           })
```



## Acknowledgments {.appendix}

This is a place to recognize people and institutions. It may also be a good place
to acknowledge and cite software that makes your work possible.

## Author Contributions {.appendix}

We strongly encourage you to include an author contributions statement briefly 
describing what each author did.

