<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Matt Worthington">
<meta name="dcterms.date" content="2023-08-10">
<meta name="description" content="Knowing SQL is a must for Data Scientists + other analytics professionals, but how can R users start practicing their SQL skills in a familiar environment? That’s this post!">
<title>Matt Worthington - Gnarly Data w/ Arrow, DuckDB, + SQL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-52682113"></script><script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-52682113', { 'anonymize_ip': true});
</script><script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script><style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #ffffff;
      }

      .quarto-title-block .quarto-title-banner {
        color: #ffffff;
      }
</style>
<script src="https://kit.fontawesome.com/20bb25f1fd.js" crossorigin="anonymous"></script><link rel="stylesheet" type="text/css" href="https://cloud.typography.com/6771036/7342412/css/fonts.css">
<link rel="stylesheet" href="page_header.css">
<meta property="og:title" content="Matt Worthington - Gnarly Data w/ Arrow, DuckDB, + SQL">
<meta property="og:description" content="Knowing SQL is a must for Data Scientists + other analytics professionals, but how can R users start practicing their SQL skills in a familiar environment? That’s this post!">
<meta property="og:image" content="https://www.mrworthington.com/articles/rstats/gnarly-data-arrow-sql-duckdb/melissa-walker-horn-U7bOjNIqisM-unsplash.jpg">
<meta property="og:site-name" content="Matt Worthington">
<meta name="twitter:title" content="Matt Worthington - Gnarly Data w/ Arrow, DuckDB, + SQL">
<meta name="twitter:description" content="Knowing SQL is a must for Data Scientists + other analytics professionals, but how can R users start practicing their SQL skills in a familiar environment? That’s this post!">
<meta name="twitter:image" content="https://www.mrworthington.com/articles/rstats/gnarly-data-arrow-sql-duckdb/melissa-walker-horn-U7bOjNIqisM-unsplash.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../logo.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Matt Worthington</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://portfolio.mrworthington.com/" rel="" target="">
 <span class="menu-text">Portfolio</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mrworthington" rel="" target=""><i class="bi bi-github" role="img" aria-label="Link to My Github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/mrworthington" rel="" target=""><i class="bi bi-twitter" role="img" aria-label="Link to My Twitter">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml" rel="" target=""><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-left">
      <div class="quarto-title-block"><div><h1 class="title">Gnarly Data w/ Arrow, DuckDB, + SQL</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          <p>Knowing SQL is a must for Data Scientists + other analytics professionals, but how can R users start practicing their SQL skills in a familiar environment? That’s this post!</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">ggplot2</div>
                <div class="quarto-category">databases</div>
                <div class="quarto-category">arrow</div>
                <div class="quarto-category">sql</div>
                <div class="quarto-category">duckdb</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://twitter.com/mrworthington">Matt Worthington</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 10, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#why-this-post" id="toc-why-this-post" class="nav-link active" data-scroll-target="#why-this-post">Why This Post?</a></li>
  <li><a href="#using-arrow-duckdb-for-sql-practice" id="toc-using-arrow-duckdb-for-sql-practice" class="nav-link" data-scroll-target="#using-arrow-duckdb-for-sql-practice">Using Arrow + DuckDB for SQL Practice</a></li>
  <li>
<a href="#exploratory-analysis-with-sql-queries-on-duckdb" id="toc-exploratory-analysis-with-sql-queries-on-duckdb" class="nav-link" data-scroll-target="#exploratory-analysis-with-sql-queries-on-duckdb">Exploratory Analysis with SQL Queries On DuckDB</a>
  <ul class="collapse">
<li><a href="#previewing-our-data" id="toc-previewing-our-data" class="nav-link" data-scroll-target="#previewing-our-data">Previewing Our Data</a></li>
  <li><a href="#filtering-on-columns" id="toc-filtering-on-columns" class="nav-link" data-scroll-target="#filtering-on-columns">Filtering On Columns</a></li>
  <li><a href="#grouping-summary-operations" id="toc-grouping-summary-operations" class="nav-link" data-scroll-target="#grouping-summary-operations">Grouping + Summary Operations</a></li>
  <li><a href="#logical-operations" id="toc-logical-operations" class="nav-link" data-scroll-target="#logical-operations">Logical Operations</a></li>
  <li><a href="#visualizing-our-query" id="toc-visualizing-our-query" class="nav-link" data-scroll-target="#visualizing-our-query">Visualizing Our Query</a></li>
  </ul>
</li>
  <li><a href="#concluding-thoughts" id="toc-concluding-thoughts" class="nav-link" data-scroll-target="#concluding-thoughts">Concluding Thoughts</a></li>
  
  </ul></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full column-page-left" id="quarto-document-content"><section id="why-this-post" class="level2"><h2 class="anchored" data-anchor-id="why-this-post">Why This Post?</h2>
<p>At work, we’re gearing up to start using SQL databases and, admittedly, it’s been a while since I’ve used SQL. While I can write <a href="https://dplyr.tidyverse.org">dplyr</a> in my sleep (<a href="https://medium.com/mlearning-ai/dplyr-vs-sql-c7277abc9482#:~:text=SQL%20and%20dplyr%20both%20are,%3E%20val1%2C%20...">which is very similar</a>), I’ve been wanting to get some practice rounds in to refresh my SQL familiarity with interesting data. In part, it’s for me but we also have folks on our team that are learning how to code and some will be using SQL for the first time. Coincidentally, Spatial Data Wizard Kyle Walker, posted this on twitter which caught my eye:</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">Many data scientists find that SQL and databases are crucial skills on the job. But how do you learn these skills coming from the <a href="https://twitter.com/hashtag/rstats?src=hash&amp;ref_src=twsrc%5Etfw">#rstats</a> world?<br><br>Ch11 of my book gets you practice setting up, querying, and analyzing a 9m record database from <a href="https://twitter.com/ipums?ref_src=twsrc%5Etfw">@ipums</a>: <a href="https://t.co/0hhD3f30Wo">https://t.co/0hhD3f30Wo</a> <a href="https://t.co/0GW1tdAQYY">pic.twitter.com/0GW1tdAQYY</a></p>— Kyle Walker (@kyle_e_walker) <a href="https://twitter.com/kyle_e_walker/status/1686762575306907648?ref_src=twsrc%5Etfw">August 2, 2023</a>
</blockquote> <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></section><section id="using-arrow-duckdb-for-sql-practice" class="level2"><h2 class="anchored" data-anchor-id="using-arrow-duckdb-for-sql-practice">Using Arrow + DuckDB for SQL Practice</h2>
<p>So I got the tutorial going and right about the time I started importing the IPUMS data into my PostgreSQL with DBeaver, I realized that loading it would take 2 hours and opted for something that could let me play with the data in SQL much faster.</p>
<p>Enter <a href="https://arrow.apache.org/docs/r/">Arrow</a> + <a href="https://duckdb.org">DuckDB</a>. If you haven’t heard of Arrow or DuckDB, they’re fairly new tools to R’s world of wizardry. They work across multiple languages, but I’ll be using their R docs for now because they’re really good.</p>
<p>So what are they? Well, Arrow bills itself as making it easy to work with “in-memory and larger-than-memory data” while DuckDB is an “in-process SQL OLAP database management system”. In layman’s terms, their purpose is for handling ridiculously large data within your local environment that may otherwise only be possible using larger, more involved database management systems. Together, they “are capable of executing on data without fully loading it from disk”.</p>
<p>That last part is key for me right now, because I don’t have 2 hours to load the export from Kyle’s tutorial in PostgreSQL before practicing. Granted, the data is pretty massive at 126,567,125 rows and 17 columns. I can’t even load the 10GB CSV extract on my M1 MacBook Pro with <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code>. If I try, RStudio’s console casually starts out like this…</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>indexing usa_00002.csv [<span class="sc">==</span><span class="er">======================================================</span><span class="sc">--</span>] <span class="fl">505.37</span>MB<span class="sc">/</span>s, eta<span class="sc">:</span>  1s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then, it just kind of hangs. After several minutes, RStudio finally taps out and says:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> ipums_csv <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"usa_00002.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Error<span class="sc">:</span> vector memory <span class="fu">exhausted</span> (limit reached?)    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So how do we load this into a database that will let us run SQL queries on Kyle’s gigantic tutorial data? Fortunately, Arrow + DuckDB’s R Packages let us easily read our CSV file in as an Arrow Table, explore it a bit, and then load it as a database that will allow us to run SQL queries on it. <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
For context, I’m going to use a parquet format (which is much lighter than CSV), but instead of <code><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet()</a></code>, you can use <code><a href="https://arrow.apache.org/docs/r/reference/read_delim_arrow.html">read_csv_arrow()</a></code> on the CSV export from IPUMS to get the same results. It will just result in slightly slower load times.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="cell">
<details open=""><summary><strong>Show the code</strong> | Build A SQL Database with Arrow + DuckDB</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://duckdb.org/">duckdb</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Reads Our IPUMS Parquet into An Arrow Table</span></span>
<span><span class="va">ipums_db</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet</a></span><span class="op">(</span><span class="st">"raw_data/ipums_export.parquet"</span>, as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Establish A Database Connection with DuckDB</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/duckdb/man/duckdb.html">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Registers arrow table as a DuckDB view</span></span>
<span><span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/to_duckdb.html">to_duckdb</a></span><span class="op">(</span><span class="va">ipums_db</span>, table_name <span class="op">=</span> <span class="st">"ipums_db"</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Source:   table&lt;ipums_db&gt; [?? x 17]</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Database: DuckDB 0.8.1 [root@Darwin 22.2.0:R 4.3.1/:memory:]</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    YEAR SAMPLE SERIAL CBSERIAL  HHWT CLUSTER STATEFIP STRATA    GQ PERNUM PERWT</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>   <span class="sc">&lt;</span>int<span class="sc">&gt;</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span>    <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span>   <span class="er">&lt;</span>dbl<span class="sc">&gt;</span>    <span class="er">&lt;</span>int<span class="sc">&gt;</span>  <span class="er">&lt;</span>dbl<span class="sc">&gt;</span> <span class="er">&lt;</span>int<span class="sc">&gt;</span>  <span class="er">&lt;</span>int<span class="sc">&gt;</span> <span class="er">&lt;</span>dbl<span class="sc">&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a> <span class="dv">1</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">1</span>    <span class="dv">97</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a> <span class="dv">2</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">2</span>    <span class="dv">97</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a> <span class="dv">3</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">3</span>    <span class="dv">97</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a> <span class="dv">4</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">4</span>    <span class="dv">97</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a> <span class="dv">5</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">5</span>    <span class="dv">97</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">6</span>    <span class="dv">97</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a> <span class="dv">7</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">7</span>    <span class="dv">97</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a> <span class="dv">8</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">8</span>    <span class="dv">97</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a> <span class="dv">9</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">101</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">9</span>    <span class="dv">97</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>  <span class="dv">1850</span> <span class="dv">185001</span>    <span class="dv">201</span>       <span class="cn">NA</span>    <span class="dv">97</span> <span class="fl">1.85e12</span>        <span class="dv">1</span> <span class="fl">1.10e8</span>     <span class="dv">1</span>      <span class="dv">1</span>    <span class="dv">97</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ℹ more rows</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ℹ 6 more variables: SEX &lt;int&gt;, AGE &lt;int&gt;, MARST &lt;int&gt;, LIT &lt;int&gt;,</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   VERSIONHIST &lt;int&gt;, HISTID &lt;chr&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section><section id="exploratory-analysis-with-sql-queries-on-duckdb" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="exploratory-analysis-with-sql-queries-on-duckdb">Exploratory Analysis with SQL Queries On DuckDB</h2>
<p>Generally, I know what’s in this data export. It’s a complete-count census file from 1910. It has features that tell us about the population (like age, sex, state, marital status, literacy, etc.) but now that it’s loaded, I want to do some high-level exploration of what’s in the 126 million rows and 17 columns. As an eyebrow raiser, I’ll note that Kyle’s tutorial says the export should have 92 million rows. So what gives?</p>
<section id="previewing-our-data" class="level3"><h3 class="anchored" data-anchor-id="previewing-our-data">Previewing Our Data</h3>
<p>For starters, I need to recall all of the features we exported so I know exactly what I’m working with before I identify why our sample is different than the one Kyke reported. It’s technically available above, but I want a small look at just 10 rows, so I’m gonna pull that sample and preview all table columns:</p>
<div class="cell">
<details open=""><summary><strong>Show the code</strong> | Previewing 10 Observations from our DB</summary><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> ipums_db <span class="kw">LIMIT</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="knitsql-table">
<table class="table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<colgroup>
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 10%">
<col style="width: 6%">
</colgroup>
<thead><tr class="header">
<th style="text-align: right;">YEAR</th>
<th style="text-align: right;">SAMPLE</th>
<th style="text-align: right;">SERIAL</th>
<th style="text-align: right;">CBSERIAL</th>
<th style="text-align: right;">HHWT</th>
<th style="text-align: right;">CLUSTER</th>
<th style="text-align: right;">STATEFIP</th>
<th style="text-align: right;">STRATA</th>
<th style="text-align: right;">GQ</th>
<th style="text-align: right;">PERNUM</th>
<th style="text-align: right;">PERWT</th>
<th style="text-align: right;">SEX</th>
<th style="text-align: right;">AGE</th>
<th style="text-align: right;">MARST</th>
<th style="text-align: right;">LIT</th>
<th style="text-align: right;">VERSIONHIST</th>
<th style="text-align: left;">HISTID</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">17</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1850</td>
<td style="text-align: right;">185001</td>
<td style="text-align: right;">201</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1.85e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">97</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="filtering-on-columns" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="filtering-on-columns">Filtering On Columns</h3>
<section id="single-column" class="level4"><h4 class="anchored" data-anchor-id="single-column">Single Column</h4>
<p>Okay, so a quick look at our sample reveals we accidentally grabbed more than the 1910 data from Kyle’s tutorial, which may explain the discrepancy in sample sizes. Let’s filter it down to match Kyle’s reported figure of 92 million rows and count it to verify since ours is 126 million.</p>
<div class="cell">
<details open=""><summary><strong>Show the code</strong> | Counting All Observations From 1910</summary><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FROM</span> ipums_db</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">YEAR</span> <span class="op">=</span> <span class="dv">1910</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="knitsql-table">
<table class="table table-sm table-striped small">
<caption>1 records</caption>
<thead><tr class="header">
<th style="text-align: right;">count_star()</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: right;">92966771</td>
</tr></tbody>
</table>
</div>
</div>
<p>It’s a match! So now, let’s re-look at a small sample with the query below, using only 1910 data. When we run it, it’s easy to see that some features now have data (like marital status) whereas they didn’t before. Likely, this may have been because the 1850 complete-count census had not included that question. Another big difference between the two is the <code>HHWT</code> column, which tells us how many households are represented in this count. For the 1850 census, they reported only accounting for 97% of US Households in their complete-count data. For the 1910 census, we see that 100% of US Households are accounted for.</p>
<div class="cell">
<details open=""><summary><strong>Show the code</strong> | Filtering on A Single Column</summary><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> ipums_db</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">YEAR</span> <span class="op">=</span> <span class="dv">1910</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="knitsql-table">
<table class="table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<colgroup>
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 4%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 2%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 3%">
<col style="width: 5%">
<col style="width: 3%">
<col style="width: 10%">
<col style="width: 6%">
</colgroup>
<thead><tr class="header">
<th style="text-align: right;">YEAR</th>
<th style="text-align: right;">SAMPLE</th>
<th style="text-align: right;">SERIAL</th>
<th style="text-align: right;">CBSERIAL</th>
<th style="text-align: right;">HHWT</th>
<th style="text-align: right;">CLUSTER</th>
<th style="text-align: right;">STATEFIP</th>
<th style="text-align: right;">STRATA</th>
<th style="text-align: right;">GQ</th>
<th style="text-align: right;">PERNUM</th>
<th style="text-align: right;">PERWT</th>
<th style="text-align: right;">SEX</th>
<th style="text-align: right;">AGE</th>
<th style="text-align: right;">MARST</th>
<th style="text-align: right;">LIT</th>
<th style="text-align: right;">VERSIONHIST</th>
<th style="text-align: left;">HISTID</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">102</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">201</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">201</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">201</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">201</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">201</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">201</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">301</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1.91e+12</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">110100100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">NA</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="multiple-columns" class="level4 page-columns page-full"><h4 class="anchored" data-anchor-id="multiple-columns">Multiple Columns</h4>
<p>Deviating a bit from Kyle’s tutorial a bit, I’m going to do an aside and explore age distributions in Texas for this example. To do that, we can start by filtering for Texans within the 1910 census sample using the <code>STATEFIP</code> Feature, which uses “FIPS” codes to classify states. Texas is number 48.</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>Now, I did count this sample outside of the tutorial (just to keep it brief) and the count for Texas in 1910 was around 3.9 million. Just over 100 years later, we’re now over 30 million. That’s pretty wild.</p>
</div></div><div class="cell">
<details open=""><summary><strong>Show the code</strong> | Filtering on Multiple Columns</summary><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="dt">YEAR</span>, <span class="kw">SAMPLE</span>, STATEFIP, SEX, AGE, LIT, MARST <span class="kw">FROM</span> ipums_db</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">YEAR</span> <span class="op">=</span> <span class="dv">1910</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> STATEFIP <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="knitsql-table">
<table class="table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<thead><tr class="header">
<th style="text-align: right;">YEAR</th>
<th style="text-align: right;">SAMPLE</th>
<th style="text-align: right;">STATEFIP</th>
<th style="text-align: right;">SEX</th>
<th style="text-align: right;">AGE</th>
<th style="text-align: right;">LIT</th>
<th style="text-align: right;">MARST</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: right;">1910</td>
<td style="text-align: right;">191002</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
</section></section><section id="grouping-summary-operations" class="level3"><h3 class="anchored" data-anchor-id="grouping-summary-operations">Grouping + Summary Operations</h3>
<p>Okay, so now we’ve previewed our Texas data, let’s build off our query above and use <code>GROUP BY</code> on the <code>AGE</code> and <code>SEX</code> variables. Interestingly, our dataset says there were a couple of folks who lived to see 120 and one woman who lived to 130 in 1910. Now, I think these folks were lying about their birth certificates, but whatever. I’m gonna set that aside for now and work with it.</p>
<div class="cell">
<details open=""><summary><strong>Show the code</strong> | Counting Texans by Age + Gender in 1910</summary><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> SEX, AGE, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="ot">"count"</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> ipums_db</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">YEAR</span> <span class="op">=</span> <span class="dv">1910</span> <span class="kw">AND</span> STATEFIP <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> AGE, SEX</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> AGE</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="knitsql-table">
<table class="table table-sm table-striped small">
<caption>Displaying records 1 - 10</caption>
<thead><tr class="header">
<th style="text-align: right;">SEX</th>
<th style="text-align: right;">AGE</th>
<th style="text-align: right;">count</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">58459</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">56893</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">47805</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">50299</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">57393</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">55398</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">56565</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">55604</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">54196</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">55697</td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="logical-operations" class="level3"><h3 class="anchored" data-anchor-id="logical-operations">Logical Operations</h3>
<p>So, maybe you’re wondering how I knew our 130yo Texan was a woman. And it’s because the IPUMS has a code book, which articulates the classification system used for certain features. In this case, it’s 1 for Male and 2 for Female. That’s all good and well, but I don’t think it’s readable and it’d be a lot better if we just reclassified these codes. We can do this by building off our query with <code>CASE</code> &amp; <code>WHEN</code></p>
<div class="cell" data-output.var="as_query" data-hash="index_cache/html/unnamed-chunk-7_29cde437f2f9fd3e221c80dfa608f168">
<details open=""><summary><strong>Show the code</strong> | Reclassifying from Coded Gender Vars</summary><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> AGE <span class="kw">as</span> <span class="ot">"age"</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> SEX <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span> <span class="st">'Male'</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>       <span class="cf">WHEN</span> SEX <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span> <span class="st">'Female'</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>       <span class="cf">ELSE</span> <span class="st">'Not Specified'</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> gender,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="ot">"count"</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> ipums_db</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="dt">YEAR</span> <span class="op">=</span> <span class="dv">1910</span> <span class="kw">AND</span> STATEFIP <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> age, gender</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> age</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="visualizing-our-query" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="visualizing-our-query">Visualizing Our Query</h3>
<p>From here, I may want to take this data and visualize it. Unfortunately, SQL really isn’t the best place to do that, but I can just pass this data to R or Python with Quarto and start going to work on some nice charts. In my case, I’ve tried to line up these two distributions and compare them by decade and gender for a simple visual comparison. While imagining the visualization in my mind, I decided to do some extra transformation on the 253 rows I pulled. It was simple enough to quickly do that within R and pass it to our chart for the comparison.</p>
<p>At a quick glance, we can some similarities in population size before age 30. Once 30 hits, the gaps start to widen. We could explore that more, but that’s not this post! So I’ll stop elaborating on this visualization for now.</p>
<div class="cell page-columns page-full" data-output.var="as_query" data-hash="index_cache/html/unnamed-chunk-8_f8219b217b9080b97c1c75ad6ffdd54b">
<details><summary><strong>Show the code</strong> | R Code to Visualize Our Query Data</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">chart_query_df</span> <span class="op">&lt;-</span> <span class="va">as_query</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>decade <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">age</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="fl">9</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="cn">Inf</span><span class="op">)</span>, </span>
<span>                      right <span class="op">=</span> <span class="cn">FALSE</span>, labels <span class="op">=</span> <span class="cn">FALSE</span>, include.lowest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         decade <span class="op">=</span> <span class="va">decade</span><span class="op">-</span><span class="fl">1</span>,</span>
<span>         decade_lbl <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">decade</span><span class="op">==</span><span class="fl">0</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">decade</span>, <span class="st">"-"</span>, <span class="va">decade</span><span class="op">+</span><span class="fl">1</span>, <span class="st">"0"</span><span class="op">)</span>,</span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">decade</span>, <span class="st">"0-"</span>, <span class="va">decade</span><span class="op">+</span><span class="fl">1</span>, <span class="st">"0"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">decade</span>, <span class="va">decade_lbl</span>, <span class="va">gender</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">chart_query_df</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">decade_lbl</span>, <span class="va">decade</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">count</span>, fill <span class="op">=</span> <span class="va">gender</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_col</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">chart_query_df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">decade</span> <span class="op">&gt;=</span> <span class="fl">30</span><span class="op">)</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span><span class="op">)</span>,<span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_number.html">label_comma</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">.001</span>, suffix <span class="op">=</span> <span class="st">"K"</span><span class="op">)</span>,</span>
<span>                     n.breaks <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>Male <span class="op">=</span> <span class="st">"#005f86"</span>, Female <span class="op">=</span> <span class="st">"#bf5700"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">mrworthingtonR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mrworthingtonR/man/theme_mrw.html">theme_mrw</a></span><span class="op">(</span>base_family <span class="op">=</span> <span class="st">"Graphik"</span>,</span>
<span>                            subtitle_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">ggtext</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/ggtext/reference/element_markdown.html">element_markdown</a></span><span class="op">(</span>margin <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>        panel.grid.major.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"#8d8d8d"</span>, <span class="fl">0.2</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"In 1910, Texas &lt;span style='color:#005f86'&gt;Men&lt;/span&gt; Seemed to Live Longer than &lt;span style='color:#bf5700'&gt;Women&lt;/span&gt; After Age 30"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Distributions Among Texan Ages, by Gender | 1910 Complete US Census Count"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Population Count"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Age Group"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"Source: IPUMS 1910 Complete-Count US Census File (CSV)"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display column-body-outset">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="index_files/figure-html/unnamed-chunk-8-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="1152"></a></p>
</figure>
</div>
</div>
</div>
</section></section><section id="concluding-thoughts" class="level2"><h2 class="anchored" data-anchor-id="concluding-thoughts">Concluding Thoughts</h2>
<p>And that’s it for me. There’s obviously more I could do more with the chart itself and there’s far more questions to ask about the underlying data (which Kyle does on his tutorial), but I’m going to pause here since this was a post to show how you can use R, Arrow, + DuckDB to wrangle gigantic volumes of data and derive insights with SQL queries! So, if you were looking for a quick database environment going so you can practice SQL, you can use this same approach with virtually any other data. Just load it into a DuckDB and start running SQL query chunks within a Quarto Doc!</p>
<p>If you have any questions, revisions, or suggestions, just shoot me a message <a href="https://twitter.com/mrworthington">on twitter or X or whatever it is now</a>.</p>
</section><div id="quarto-appendix" class="default"><section id="acknowledgments" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Acknowledgments</h2><div class="quarto-appendix-contents">
<p>Photo by <a href="https://unsplash.com/@sugercoatit?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Melissa Walker Horn</a> on <a href="https://unsplash.com/photos/U7bOjNIqisM?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>


<!-- -->

</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>
<ol>
<li id="fn1"><p>For a good tutorial on this approach, visit <a href="&quot;https://duckdb.org/2021/12/03/duck-arrow.html">this page on DuckDB’s blog</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/www\.mrworthington\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb12" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Gnarly Data w/ Arrow, DuckDB, + SQL"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> |</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">  Knowing SQL is a must for Data Scientists + other analytics professionals, but how can R users start practicing their SQL skills in a familiar environment? That's this post!</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: Matt Worthington </span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    url: https://twitter.com/mrworthington</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-08-10</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="an">page-layout:</span><span class="co"> full</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    date_format: medium</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">    css: page_header.css</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-width: 8</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">    warning: false</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">    message: false</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co">    code-link: true</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-banner:</span><span class="co"> true</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="an">title-block-banner-color:</span><span class="co"> "#ffffff"</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> melissa-walker-horn-U7bOjNIqisM-unsplash.jpg</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co">  - ggplot2</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co">  - databases</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co">  - arrow</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co">  - sql</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co">  - duckdb</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="an">filters:</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co">   - lightbox</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="an">lightbox:</span><span class="co"> auto</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why This Post?</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>At work, we're gearing up to start using SQL databases and, admittedly, it's been a while since I've used SQL. While I can write <span class="co">[</span><span class="ot">dplyr</span><span class="co">](https://dplyr.tidyverse.org)</span> in my sleep (<span class="co">[</span><span class="ot">which is very similar</span><span class="co">](https://medium.com/mlearning-ai/dplyr-vs-sql-c7277abc9482#:~:text=SQL%20and%20dplyr%20both%20are,%3E%20val1%2C%20...)</span>), I've been wanting to get some practice rounds in to refresh my SQL familiarity with interesting data. In part, it's for me but we also have folks on our team that are learning how to code and some will be using SQL for the first time. Coincidentally, Spatial Data Wizard Kyle Walker, posted this on twitter which caught my eye:</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;blockquote class="twitter-tweet"&gt;&lt;p lang="en" dir="ltr"&gt;Many data scientists find that SQL and databases are crucial skills on the job. But how do you learn these skills coming from the &lt;a href="https://twitter.com/hashtag/rstats?src=hash&amp;amp;ref_src=twsrc%5Etfw"&gt;#rstats&lt;/a&gt; world?&lt;br&gt;&lt;br&gt;Ch11 of my book gets you practice setting up, querying, and analyzing a 9m record database from &lt;a href="https://twitter.com/ipums?ref_src=twsrc%5Etfw"&gt;@ipums&lt;/a&gt;: &lt;a href="https://t.co/0hhD3f30Wo"&gt;https://t.co/0hhD3f30Wo&lt;/a&gt; &lt;a href="https://t.co/0GW1tdAQYY"&gt;pic.twitter.com/0GW1tdAQYY&lt;/a&gt;&lt;/p&gt;&amp;mdash; Kyle Walker (@kyle_e_walker) &lt;a href="https://twitter.com/kyle_e_walker/status/1686762575306907648?ref_src=twsrc%5Etfw"&gt;August 2, 2023&lt;/a&gt;&lt;/blockquote&gt; &lt;script async src="https://platform.twitter.com/widgets.js" charset="utf-8"&gt;&lt;/script&gt;</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using Arrow + DuckDB for SQL Practice</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>So I got the tutorial going and right about the time I started importing the IPUMS data into my PostgreSQL with DBeaver, I realized that loading it would take 2 hours and opted for something that could let me play with the data in SQL much faster.</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>Enter <span class="co">[</span><span class="ot">Arrow</span><span class="co">](https://arrow.apache.org/docs/r/)</span> + <span class="co">[</span><span class="ot">DuckDB</span><span class="co">](https://duckdb.org)</span>. If you haven't heard of Arrow or DuckDB, they're fairly new tools to R's world of wizardry. They work across multiple languages, but I'll be using their R docs for now because they're really good.</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>So what are they? Well, Arrow bills itself as making it easy to work with "in-memory and larger-than-memory data" while DuckDB is an "in-process SQL OLAP database management system". In layman's terms, their purpose is for handling ridiculously large data within your local environment that may otherwise only be possible using larger, more involved database management systems. Together, they "are capable of executing on data without fully loading it from disk".</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>That last part is key for me right now, because I don't have 2 hours to load the export from Kyle's tutorial in PostgreSQL before practicing. Granted, the data is pretty massive at 126,567,125 rows and 17 columns. I can't even load the 10GB CSV extract on my M1 MacBook Pro with <span class="in">`read_csv()`</span>. If I try, RStudio's console casually starts out like this...</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>indexing usa_00002.csv [<span class="sc">==</span><span class="er">======================================================</span><span class="sc">--</span>] <span class="fl">505.37</span>MB<span class="sc">/</span>s, eta<span class="sc">:</span>  1s</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>Then, it just kind of hangs. After several minutes, RStudio finally taps out and says:</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> ipums_csv <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"usa_00002.csv"</span>)</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>Error<span class="sc">:</span> vector memory <span class="fu">exhausted</span> (limit reached?)    </span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>So how do we load this into a database that will let us run SQL queries on Kyle's gigantic tutorial data? Fortunately, Arrow + DuckDB's R Packages let us easily read our CSV file in as an Arrow Table, explore it a bit, and then load it as a database that will allow us to run SQL queries on it. <span class="ot">[^1]</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="ot">[^1]: </span>For a good tutorial on this approach, visit <span class="co">[</span><span class="ot">this page on DuckDB's blog</span><span class="co">](%22https://duckdb.org/2021/12/03/duck-arrow.html)</span>.</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>::: {.callout-note appearance="simple"}</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## For context, I'm going to use a parquet format (which is much lighter than CSV), but instead of `read_parquet()`, you can use `read_csv_arrow()` on the CSV export from IPUMS to get the same results. It will just result in slightly slower load times.</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: sourceCode r code-with-copy</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Build A SQL Database with Arrow + DuckDB"</span></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(duckdb)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a><span class="do">## Reads Our IPUMS Parquet into An Arrow Table</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>ipums_db <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(<span class="st">"raw_data/ipums_export.parquet"</span>, <span class="at">as_data_frame =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish A Database Connection with DuckDB</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(duckdb<span class="sc">::</span><span class="fu">duckdb</span>())</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Registers arrow table as a DuckDB view</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>arrow<span class="sc">::</span><span class="fu">to_duckdb</span>(ipums_db, <span class="at">table_name =</span> <span class="st">"ipums_db"</span>, <span class="at">con =</span> con)</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exploratory Analysis with SQL Queries On DuckDB</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>Generally, I know what's in this data export. It's a complete-count census file from 1910. It has features that tell us about the population (like age, sex, state, marital status, literacy, etc.) but now that it's loaded, I want to do some high-level exploration of what's in the 126 million rows and 17 columns. As an eyebrow raiser, I'll note that Kyle's tutorial says the export should have 92 million rows. So what gives?</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a><span class="fu">### Previewing Our Data</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>For starters, I need to recall all of the features we exported so I know exactly what I'm working with before I identify why our sample is different than the one Kyke reported. It's technically available above, but I want a small look at just 10 rows, so I'm gonna pull that sample and preview all table columns:</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql connection = "con"}</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: sourceCode sql code-with-copy</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Previewing 10 Observations from our DB"</span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> ipums_db <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filtering On Columns</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Single Column</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>Okay, so a quick look at our sample reveals we accidentally grabbed more than the 1910 data from Kyle's tutorial, which may explain the discrepancy in sample sizes. Let's filter it down to match Kyle's reported figure of 92 million rows and count it to verify since ours is 126 million.</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql connection = "con"}</span></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: sourceCode sql code-with-copy</span></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Counting All Observations From 1910"</span></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">count</span>(<span class="op">*</span>) <span class="kw">FROM</span> ipums_db</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="fu">YEAR</span> <span class="op">=</span> <span class="dv">1910</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>It's a match! So now, let's re-look at a small sample with the query below, using only 1910 data. When we run it, it's easy to see that some features now have data (like marital status) whereas they didn't before. Likely, this may have been because the 1850 complete-count census had not included that question. Another big difference between the two is the <span class="in">`HHWT`</span> column, which tells us how many households are represented in this count. For the 1850 census, they reported only accounting for 97% of US Households in their complete-count data. For the 1910 census, we see that 100% of US Households are accounted for.</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql connection = "con"}</span></span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: sourceCode sql code-with-copy</span></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Filtering on A Single Column"</span></span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> ipums_db</span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="fu">YEAR</span> <span class="op">=</span> <span class="dv">1910</span></span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Multiple Columns</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a>Deviating a bit from Kyle's tutorial a bit, I'm going to do an aside and explore age distributions in Texas for this example. To do that, we can start by filtering for Texans within the 1910 census sample using the <span class="in">`STATEFIP`</span> Feature, which uses "FIPS" codes to classify states. Texas is number 48. </span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>::: aside</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>Now, I did count this sample outside of the tutorial (just to keep it brief) and the count for Texas in 1910 was around 3.9 million. Just over 100 years later, we're now over 30 million. That's pretty wild.</span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql connection = "con"}</span></span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: sourceCode sql code-with-copy</span></span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Filtering on Multiple Columns"</span></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="fu">YEAR</span>, SAMPLE, STATEFIP, SEX, AGE, LIT, MARST <span class="kw">FROM</span> ipums_db</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="fu">YEAR</span> <span class="op">=</span> <span class="dv">1910</span></span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> STATEFIP <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="fu">### Grouping + Summary Operations</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>Okay, so now we've previewed our Texas data, let's build off our query above and use <span class="in">`GROUP BY`</span> on the <span class="in">`AGE`</span> and <span class="in">`SEX`</span> variables. Interestingly, our dataset says there were a couple of folks who lived to see 120 and one woman who lived to 130 in 1910. Now, I think these folks were lying about their birth certificates, but whatever. I'm gonna set that aside for now and work with it.  </span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql connection = "con"}</span></span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: sourceCode sql code-with-copy</span></span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Counting Texans by Age + Gender in 1910"</span></span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> SEX, AGE, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="st">"count"</span> </span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> ipums_db</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="fu">YEAR</span> <span class="op">=</span> <span class="dv">1910</span> <span class="kw">AND</span> STATEFIP <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> AGE, SEX</span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> AGE</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a><span class="fu">### Logical Operations</span></span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a>So, maybe you're wondering how I knew our 130yo Texan was a woman. And it's because the IPUMS has a code book, which articulates the classification system used for certain features. In this case, it's 1 for Male and 2 for Female. That's all good and well, but I don't think it's readable and it'd be a lot better if we just reclassified these codes. We can do this by building off our query with <span class="in">`CASE`</span> &amp; <span class="in">`WHEN`</span></span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{sql}</span></span>
<span id="cb12-176"><a href="#cb12-176" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: show</span></span>
<span id="cb12-177"><a href="#cb12-177" aria-hidden="true" tabindex="-1"></a><span class="co">#| connection: con</span></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| output.var: as_query</span></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| class-output: sourceCode sql code-with-copy</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | Reclassifying from Coded Gender Vars"</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> AGE <span class="kw">as</span> <span class="st">"age"</span>,</span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">CASE</span> <span class="cf">WHEN</span> SEX <span class="op">=</span> <span class="dv">1</span> <span class="cf">then</span> <span class="st">'Male'</span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a>       <span class="cf">WHEN</span> SEX <span class="op">=</span> <span class="dv">2</span> <span class="cf">then</span> <span class="st">'Female'</span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a>       <span class="cf">ELSE</span> <span class="st">'Not Specified'</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a>  <span class="cf">END</span> <span class="kw">AS</span> gender,</span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">AS</span> <span class="st">"count"</span></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> ipums_db</span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a>  <span class="kw">WHERE</span> <span class="fu">YEAR</span> <span class="op">=</span> <span class="dv">1910</span> <span class="kw">AND</span> STATEFIP <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a>  <span class="kw">GROUP</span> <span class="kw">BY</span> age, gender</span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> age</span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing Our Query</span></span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a>From here, I may want to take this data and visualize it. Unfortunately, SQL really isn't the best place to do that, but I can just pass this data to R or Python with Quarto and start going to work on some nice charts. In my case, I've tried to line up these two distributions and compare them by decade and gender for a simple visual comparison. While imagining the visualization in my mind, I decided to do some extra transformation on the 253 rows I pulled. It was simple enough to quickly do that within R and pass it to our chart for the comparison. </span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a>At a quick glance, we can some similarities in population size before age 30. Once 30 hits, the gaps start to widen. We could explore that more, but that's not this post! So I'll stop elaborating on this visualization for now.</span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-204"><a href="#cb12-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb12-205"><a href="#cb12-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| connection: con</span></span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a><span class="co">#| output.var: as_query</span></span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 9</span></span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| column: body-outset</span></span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "**Show the code** | R Code to Visualize Our Query Data"</span></span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>chart_query_df <span class="ot">&lt;-</span> as_query <span class="sc">|&gt;</span> </span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">decade =</span> <span class="fu">cut</span>(age, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(age) <span class="sc">+</span> <span class="dv">9</span>, <span class="at">by =</span> <span class="dv">10</span>), <span class="cn">Inf</span>), </span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>                      <span class="at">right =</span> <span class="cn">FALSE</span>, <span class="at">labels =</span> <span class="cn">FALSE</span>, <span class="at">include.lowest =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a>         <span class="at">decade =</span> decade<span class="dv">-1</span>,</span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a>         <span class="at">decade_lbl =</span> <span class="fu">if_else</span>(decade<span class="sc">==</span><span class="dv">0</span>,</span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">paste0</span>(decade, <span class="st">"-"</span>, decade<span class="sc">+</span><span class="dv">1</span>, <span class="st">"0"</span>),</span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">paste0</span>(decade, <span class="st">"0-"</span>, decade<span class="sc">+</span><span class="dv">1</span>, <span class="st">"0"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(decade, decade_lbl, gender) <span class="sc">|&gt;</span> </span>
<span id="cb12-222"><a href="#cb12-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">count =</span> <span class="fu">sum</span>(count))</span>
<span id="cb12-223"><a href="#cb12-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a>chart_query_df <span class="sc">|&gt;</span> </span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">reorder</span>(decade_lbl, decade), <span class="at">y =</span> count, <span class="at">fill =</span> gender) <span class="sc">+</span></span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>()) <span class="sc">+</span></span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">data =</span> chart_query_df <span class="sc">|&gt;</span> <span class="fu">filter</span>(decade <span class="sc">&gt;=</span> <span class="dv">30</span>), <span class="at">position =</span> <span class="fu">position_dodge</span>(),) <span class="sc">+</span> </span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_comma</span>(<span class="at">scale =</span> .<span class="dv">001</span>, <span class="at">suffix =</span> <span class="st">"K"</span>),</span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a>                     <span class="at">n.breaks =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">Male =</span> <span class="st">"#005f86"</span>, <span class="at">Female =</span> <span class="st">"#bf5700"</span>)) <span class="sc">+</span> </span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>  mrworthingtonR<span class="sc">::</span><span class="fu">theme_mrw</span>(<span class="at">base_family =</span> <span class="st">"Graphik"</span>,</span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>                            <span class="at">subtitle_size =</span> <span class="dv">18</span>) <span class="sc">+</span></span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> ggtext<span class="sc">::</span><span class="fu">element_markdown</span>(<span class="at">margin =</span> ggplot2<span class="sc">::</span><span class="fu">margin</span>(<span class="at">b =</span> <span class="dv">5</span>), <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="fu">alpha</span>(<span class="st">"#8d8d8d"</span>, <span class="fl">0.2</span>), <span class="at">linetype =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"In 1910, Texas &lt;span style='color:#005f86'&gt;Men&lt;/span&gt; Seemed to Live Longer than &lt;span style='color:#bf5700'&gt;Women&lt;/span&gt; After Age 30"</span>,</span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Distributions Among Texan Ages, by Gender | 1910 Complete US Census Count"</span>,</span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Population Count"</span>,</span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Age Group"</span>,</span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a>       <span class="at">caption =</span> <span class="st">"Source: IPUMS 1910 Complete-Count US Census File (CSV)"</span>)</span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a><span class="fu">## Concluding Thoughts</span></span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a>And that's it for me. There's obviously more I could do more with the chart itself and there's far more questions to ask about the underlying data (which Kyle does on his tutorial), but I'm going to pause here since this was a post to show how you can use R, Arrow, + DuckDB to wrangle gigantic volumes of data and derive insights with SQL queries! So, if you were looking for a quick database environment going so you can practice SQL, you can use this same approach with virtually any other data. Just load it into a DuckDB and start running SQL query chunks within a Quarto Doc! </span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a>If you have any questions, revisions, or suggestions, just shoot me a message <span class="co">[</span><span class="ot">on twitter or X or whatever it is now</span><span class="co">](https://twitter.com/mrworthington)</span>.</span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a><span class="fu">## Acknowledgments {.appendix}</span></span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a>Photo by <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://unsplash.com/@sugercoatit?utm_source=unsplash</span><span class="er">&amp;</span><span class="st">utm_medium=referral</span><span class="er">&amp;</span><span class="st">utm_content=creditCopyText"</span><span class="kw">&gt;</span>Melissa Walker Horn<span class="kw">&lt;/a&gt;</span> on <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://unsplash.com/photos/U7bOjNIqisM?utm_source=unsplash</span><span class="er">&amp;</span><span class="st">utm_medium=referral</span><span class="er">&amp;</span><span class="st">utm_content=creditCopyText"</span><span class="kw">&gt;</span>Unsplash<span class="kw">&lt;/a&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer><script>var lightboxQuarto = GLightbox({"loop":true,"selector":".lightbox","closeEffect":"zoom","openEffect":"zoom","descPosition":"bottom"});</script>


</body></html>